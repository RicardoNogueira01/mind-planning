// Prisma Schema for Mind Planning Application
// ============================================
// This schema defines the database structure
// Run: npx prisma generate
// Run: npx prisma db push (for development)
// Run: npx prisma migrate dev (for migrations)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Can change to mysql, sqlite, sqlserver
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  admin
  team_manager
  user
  viewer
  auditor
}

enum TaskStatus {
  not_started
  in_progress
  blocked
  waiting
  completed
  cancelled
}

enum TaskPriority {
  critical
  high
  medium
  low
}

enum HolidayStatus {
  pending
  approved
  rejected
  cancelled
}

enum ProjectStatus {
  planning
  active
  on_hold
  completed
  archived
}

enum NotificationType {
  task_assigned
  task_completed
  task_overdue
  mention
  comment
  holiday_approved
  holiday_rejected
  project_update
  deadline_reminder
  handoff
  system
}

enum ExpenseCategory {
  software
  hardware
  services
  travel
  office
  training
  events
  meals
  gifts
  other
}

enum ExpenseStatus {
  pending
  approved
  rejected
  reimbursed
}

enum DecisionCategory {
  technical
  design
  process
  resource
  timeline
  scope
  other
}

enum DecisionStatus {
  final
  pending
  revised
}

enum DocumentType {
  document
  image
  pdf
  link
  other
}

enum DocumentCategory {
  guides
  templates
  policies
  onboarding
  technical
  design
  other
}

enum HandoffStatus {
  pending
  in_progress
  completed
  cancelled
}

enum ResourceType {
  person
  equipment
  room
  software
  license
  other
}

// ============================================
// CORE MODELS
// ============================================

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Identity
  email     String   @unique
  password  String   // Hashed password
  name      String
  initials  String
  avatar    String?
  color     String   @default("#6366f1")
  
  // Role & Status
  role      UserRole @default(user)
  isActive  Boolean  @default(true)
  
  // Profile
  phone     String?
  location  String?
  department String?
  jobTitle  String?
  bio       String?
  
  // Social links
  linkedinUrl String?
  githubUrl   String?
  websiteUrl  String?
  
  // Skills (stored as JSON array)
  skills    Json     @default("[]")
  
  // Settings (stored as JSON)
  settings  Json?
  
  // Organization
  organizationId String
  organization   Organization @relation("OrganizationMembers", fields: [organizationId], references: [id])
  
  // Organizations owned by this user
  ownedOrganizations Organization[] @relation("OrganizationOwner")
  
  // Teams
  managedTeams   Team[]   @relation("TeamManager")
  memberOfTeams  TeamMember[]
  
  // Projects
  createdProjects   Project[]     @relation("ProjectCreator")
  memberOfProjects  ProjectMember[]
  
  // MindMaps
  createdMindMaps   MindMap[]     @relation("MindMapCreator")
  sharedMindMaps    MindMapShare[]
  modifiedMindMaps  MindMap[]     @relation("MindMapLastModifier")
  mindMapSnapshots  MindMapSnapshot[]
  
  // Nodes (Tasks)
  createdNodes      Node[]        @relation("NodeCreator")
  assignedNodes     Node[]        @relation("NodeAssignee")
  
  // Holidays
  holidayRequests   HolidayRequest[] @relation("HolidayRequestor")
  reviewedHolidays  HolidayRequest[] @relation("HolidayReviewer")
  
  // Attachments
  uploadedAttachments Attachment[]
  
  // Comments
  comments          Comment[]
  mentionedInComments CommentMention[]
  
  // Notifications
  notifications     Notification[] @relation("NotificationRecipient")
  triggeredNotifications Notification[] @relation("NotificationTrigger")
  
  // Activity Log
  activityLogs      ActivityLog[]
  
  // Decisions
  createdDecisions  Decision[]    @relation("DecisionCreator")
  madeDecisions     Decision[]    @relation("DecisionMaker")
  decisionStakeholder DecisionStakeholder[]
  
  // Expenses
  createdExpenses   Expense[]     @relation("ExpenseCreator")
  paidExpenses      Expense[]     @relation("ExpensePayer")
  approvedExpenses  Expense[]     @relation("ExpenseApprover")
  expenseParticipant ExpenseParticipant[]
  
  // Automations
  createdAutomations AutomationRule[]
  
  // Knowledge Base
  createdDocuments   KnowledgeDocument[]  @relation("DocumentCreator")
  modifiedDocuments  KnowledgeDocument[]  @relation("DocumentModifier")
  starredDocuments   DocumentStar[]
  
  // Time Tracking & Workload
  timeEntries        TimeEntry[]
  workloadEntries    WorkloadEntry[]
  
  // Handoffs
  handoffsFrom       NodeHandoff[]        @relation("HandoffFrom")
  handoffsTo         NodeHandoff[]        @relation("HandoffTo")
  
  // Resources
  createdResources   Resource[]           @relation("ResourceCreator")
  resourceAllocations ResourceAllocation[]
  
  // Budgets
  createdBudgets     Budget[]             @relation("BudgetCreator")
  
  // Node multiple assignees
  nodeAssignments    NodeAssignee[]
  
  // Sessions
  sessions          Session[]
  
  @@index([email])
  @@index([organizationId])
  @@index([role])
}

model Session {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token        String   @unique
  ipAddress    String?
  userAgent    String?
  
  @@index([token])
  @@index([userId])
}

model Organization {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  name      String
  slug      String   @unique
  logo      String?
  
  // Settings (stored as JSON)
  settings  Json?
  
  // Owner
  ownerId   String
  owner     User     @relation("OrganizationOwner", fields: [ownerId], references: [id])
  
  // Relationships
  members   User[]   @relation("OrganizationMembers")
  teams     Team[]
  projects  Project[]
  automations AutomationRule[]
  
  // Knowledge Base
  documents KnowledgeDocument[]
  
  // Resources
  resources Resource[]
  
  // Budgets
  budgets   Budget[]
  
  // Country Holidays (org-specific)
  holidays  CountryHoliday[]
  
  @@index([slug])
  @@index([ownerId])
}

model Team {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  name        String
  description String?
  color       String   @default("#6366f1")
  
  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Manager
  managerId   String
  manager     User     @relation("TeamManager", fields: [managerId], references: [id])
  
  // Members
  members     TeamMember[]
  
  // Projects
  projects    Project[]
  
  // Shared MindMaps
  sharedMindMaps MindMapTeamShare[]
  
  @@index([organizationId])
  @@index([managerId])
}

model TeamMember {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model Project {
  id          String        @id @default(cuid())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  name        String
  description String?
  color       String        @default("#6366f1")
  status      ProjectStatus @default(planning)
  
  // Dates
  startDate   DateTime?
  endDate     DateTime?
  
  // Budget
  budget      Float?
  currency    String?       @default("USD")
  
  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Team (optional)
  teamId      String?
  team        Team?         @relation(fields: [teamId], references: [id])
  
  // Creator
  createdById String
  createdBy   User          @relation("ProjectCreator", fields: [createdById], references: [id])
  
  // Members
  members     ProjectMember[]
  
  // Content
  mindMaps    MindMap[]
  nodes       Node[]
  decisions   Decision[]
  expenses    Expense[]
  automations AutomationRule[]
  
  // Knowledge Base
  documents   KnowledgeDocument[]
  
  // Time Tracking
  timeEntries TimeEntry[]
  
  // Budgets
  budgets     Budget[]
  
  // Timeline / Gantt
  timelineItems TimelineItem[]
  
  // Resource Allocations
  resourceAllocations ResourceAllocation[]
  
  @@index([organizationId])
  @@index([teamId])
  @@index([createdById])
  @@index([status])
}

model ProjectMember {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Role within project (can be different from global role)
  role      String   @default("member") // owner, admin, member, viewer
  
  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model MindMap {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  title       String
  description String?
  color       String    @default("#6366f1")
  isFavorite  Boolean   @default(false)
  isTemplate  Boolean   @default(false)
  isPublic    Boolean   @default(false)
  
  // Project (optional)
  projectId   String?
  project     Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  // Creator
  createdById String
  createdBy   User      @relation("MindMapCreator", fields: [createdById], references: [id])
  
  // Last modifier
  lastModifiedById String?
  lastModifiedBy   User?   @relation("MindMapLastModifier", fields: [lastModifiedById], references: [id])
  
  // Sharing
  sharedWithUsers MindMapShare[]
  sharedWithTeams MindMapTeamShare[]
  
  // Snapshots
  snapshots   MindMapSnapshot[]
  
  // Nodes (each node is a task)
  nodes       Node[]
  
  // Connections between nodes
  connections NodeConnection[]
  
  // Attachments
  attachments Attachment[]
  
  @@index([projectId])
  @@index([createdById])
  @@index([isTemplate])
  @@index([isPublic])
}

model MindMapShare {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  mindMapId String
  mindMap   MindMap  @relation(fields: [mindMapId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  canEdit   Boolean  @default(false)
  
  @@unique([mindMapId, userId])
  @@index([mindMapId])
  @@index([userId])
}

model MindMapTeamShare {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  mindMapId String
  mindMap   MindMap  @relation(fields: [mindMapId], references: [id], onDelete: Cascade)
  
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  canEdit   Boolean  @default(false)
  
  @@unique([mindMapId, teamId])
  @@index([mindMapId])
  @@index([teamId])
}

model MindMapSnapshot {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  
  name        String
  description String?
  nodes       Json     // Snapshot of nodes state
  connections Json     // Snapshot of connections state
  
  mindMapId   String
  mindMap     MindMap  @relation(fields: [mindMapId], references: [id], onDelete: Cascade)
  
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  
  @@index([mindMapId])
  @@index([createdById])
}

// ============================================
// NODE - Unified Task/Node Entity
// Each node in a MindMap IS a task
// ============================================

model Node {
  id          String       @id @default(cuid())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // ===== VISUAL PROPERTIES =====
  // Position on canvas
  x           Float        @default(0)
  y           Float        @default(0)
  
  // Appearance
  bgColor     String       @default("#ffffff")
  fontColor   String       @default("#000000")
  shapeType   String       @default("rectangle") // rectangle, rounded, diamond, ellipse, hexagon
  emoji       String?
  
  // ===== TASK PROPERTIES =====
  // Content
  text        String       // Main text/title
  notes       String?      @db.Text // Rich text notes/description
  
  // Status & Priority
  status      TaskStatus   @default(not_started)
  priority    TaskPriority @default(medium)
  completed   Boolean      @default(false)
  
  // Dates
  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?
  
  // Time tracking
  estimatedHours Float?
  loggedHours    Float?    @default(0)
  
  // Tags (stored as JSON array)
  tags        Json         @default("[]")
  
  // ===== RELATIONSHIPS =====
  
  // MindMap this node belongs to
  mindMapId   String
  mindMap     MindMap      @relation(fields: [mindMapId], references: [id], onDelete: Cascade)
  
  // Creator
  createdById String
  createdBy   User         @relation("NodeCreator", fields: [createdById], references: [id])
  
  // Primary Assignee
  assigneeId  String?
  assignee    User?        @relation("NodeAssignee", fields: [assigneeId], references: [id])
  
  // Project (denormalized from MindMap for easier queries)
  projectId   String?
  project     Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  // Parent node (for hierarchical/subtask structure)
  parentId    String?
  parent      Node?        @relation("NodeHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Node[]       @relation("NodeHierarchy")
  
  // Connections (outgoing)
  connectionsFrom NodeConnection[] @relation("ConnectionFrom")
  connectionsTo   NodeConnection[] @relation("ConnectionTo")
  
  // Dependencies (blocking relationships)
  blockedByNodes  NodeDependency[] @relation("BlockedNode")
  blockingNodes   NodeDependency[] @relation("BlockingNode")
  
  // Multiple assignees (for collaborative tasks)
  assignees   NodeAssignee[]
  
  // Attachments
  attachments Attachment[]
  
  // Comments
  comments    Comment[]
  
  // Activity
  activityLogs ActivityLog[]
  
  // Notifications
  notifications Notification[]
  
  // Decisions linked to this node
  decisions   NodeDecision[]
  
  // Handoffs
  handoffs    NodeHandoff[]
  
  // Time entries
  timeEntries TimeEntry[]
  
  @@index([mindMapId])
  @@index([createdById])
  @@index([assigneeId])
  @@index([projectId])
  @@index([parentId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([completed])
}

// Connection between two nodes in a MindMap
model NodeConnection {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  
  // Visual properties
  label       String?
  style       String   @default("solid") // solid, dashed, dotted
  color       String?
  
  // Source node
  fromId      String
  from        Node     @relation("ConnectionFrom", fields: [fromId], references: [id], onDelete: Cascade)
  
  // Target node
  toId        String
  to          Node     @relation("ConnectionTo", fields: [toId], references: [id], onDelete: Cascade)
  
  // MindMap (denormalized for easier queries)
  mindMapId   String
  mindMap     MindMap  @relation(fields: [mindMapId], references: [id], onDelete: Cascade)
  
  @@unique([fromId, toId])
  @@index([fromId])
  @@index([toId])
  @@index([mindMapId])
}

// Dependency relationship (blocking) between nodes
model NodeDependency {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  
  // The node that is blocked
  blockedNodeId  String
  blockedNode    Node    @relation("BlockedNode", fields: [blockedNodeId], references: [id], onDelete: Cascade)
  
  // The node that is blocking
  blockingNodeId String
  blockingNode   Node    @relation("BlockingNode", fields: [blockingNodeId], references: [id], onDelete: Cascade)
  
  @@unique([blockedNodeId, blockingNodeId])
  @@index([blockedNodeId])
  @@index([blockingNodeId])
}

// Many-to-many relationship for multiple node assignees
model NodeAssignee {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  nodeId    String
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Role in this node/task
  role      String   @default("assignee") // assignee, reviewer, observer
  
  // Hours allocated to this person
  allocatedHours Float?
  
  @@unique([nodeId, userId])
  @@index([nodeId])
  @@index([userId])
}

model HolidayRequest {
  id          String        @id @default(cuid())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  startDate   DateTime
  endDate     DateTime
  totalDays   Int
  reason      String?
  status      HolidayStatus @default(pending)
  
  // Requestor
  userId      String
  user        User          @relation("HolidayRequestor", fields: [userId], references: [id], onDelete: Cascade)
  
  // Reviewer
  reviewedById String?
  reviewedBy   User?        @relation("HolidayReviewer", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?
  reviewNotes  String?
  
  @@index([userId])
  @@index([reviewedById])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

model Attachment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  name      String
  url       String
  mimeType  String
  size      Int
  
  // Uploader
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  
  // Can be attached to Node or MindMap
  nodeId    String?
  node      Node?    @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  
  mindMapId String?
  mindMap   MindMap? @relation(fields: [mindMapId], references: [id], onDelete: Cascade)
  
  @@index([uploadedById])
  @@index([nodeId])
  @@index([mindMapId])
}

model Comment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  content   String
  
  // Author
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  // Node
  nodeId    String
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  
  // Reply threading
  parentCommentId String?
  parentComment   Comment?  @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies         Comment[] @relation("CommentReplies")
  
  // Mentions
  mentions  CommentMention[]
  
  @@index([authorId])
  @@index([nodeId])
  @@index([parentCommentId])
}

model CommentMention {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  commentId String
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

model Notification {
  id        String           @id @default(cuid())
  createdAt DateTime         @default(now())
  
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  readAt    DateTime?
  
  // Recipient
  userId    String
  user      User             @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  
  // Trigger (who caused this notification)
  triggeredById String?
  triggeredBy   User?        @relation("NotificationTrigger", fields: [triggeredById], references: [id])
  
  // Related entities (optional)
  nodeId    String?
  node      Node?            @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  
  // Action URL
  actionUrl String?
  
  @@index([userId])
  @@index([triggeredById])
  @@index([nodeId])
  @@index([isRead])
  @@index([createdAt])
}

model ActivityLog {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  
  action      String
  entityType  String   // node, project, mindmap, user, holiday, comment
  entityId    String
  changes     Json?    // { field: { old: value, new: value } }
  
  // Who did it
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Context
  ipAddress   String?
  userAgent   String?
  
  // Optional node reference for quick queries
  nodeId      String?
  node        Node?    @relation(fields: [nodeId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([nodeId])
  @@index([createdAt])
}

model Decision {
  id          String           @id @default(cuid())
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  title       String
  description String
  category    DecisionCategory
  status      DecisionStatus   @default(pending)
  decidedAt   DateTime?
  
  // Creator
  createdById String
  createdBy   User             @relation("DecisionCreator", fields: [createdById], references: [id])
  
  // Decision maker
  decidedById String?
  decidedBy   User?            @relation("DecisionMaker", fields: [decidedById], references: [id])
  
  // Project
  projectId   String?
  project     Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  // Related nodes
  nodes       NodeDecision[]
  
  // Stakeholders
  stakeholders DecisionStakeholder[]
  
  @@index([createdById])
  @@index([decidedById])
  @@index([projectId])
  @@index([status])
}

model NodeDecision {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  
  nodeId     String
  node       Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  
  decisionId String
  decision   Decision @relation(fields: [decisionId], references: [id], onDelete: Cascade)
  
  @@unique([nodeId, decisionId])
  @@index([nodeId])
  @@index([decisionId])
}

model DecisionStakeholder {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  
  decisionId String
  decision   Decision @relation(fields: [decisionId], references: [id], onDelete: Cascade)
  
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([decisionId, userId])
  @@index([decisionId])
  @@index([userId])
}

model Expense {
  id          String          @id @default(cuid())
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  description String
  amount      Float
  currency    String          @default("USD")
  date        DateTime
  category    ExpenseCategory
  status      ExpenseStatus   @default(pending)
  
  receiptUrl  String?
  
  // Creator
  createdById String
  createdBy   User            @relation("ExpenseCreator", fields: [createdById], references: [id])
  
  // Who paid
  paidById    String
  paidBy      User            @relation("ExpensePayer", fields: [paidById], references: [id])
  
  // Approval
  approvedById String?
  approvedBy   User?          @relation("ExpenseApprover", fields: [approvedById], references: [id])
  approvedAt   DateTime?
  
  // Project
  projectId   String?
  project     Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  // Split participants
  participants ExpenseParticipant[]
  
  @@index([createdById])
  @@index([paidById])
  @@index([approvedById])
  @@index([projectId])
  @@index([status])
  @@index([date])
}

model ExpenseParticipant {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  expenseId String
  expense   Expense  @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  share     Float?   // Optional: specific share amount
  
  @@unique([expenseId, userId])
  @@index([expenseId])
  @@index([userId])
}

model AutomationRule {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  name      String
  isEnabled Boolean  @default(true)
  
  // Trigger, conditions, actions (stored as JSON)
  trigger    Json
  conditions Json     @default("[]")
  actions    Json
  
  // Stats
  runCount   Int      @default(0)
  lastRunAt  DateTime?
  
  // Creator
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  
  // Scope (can be project-level or org-level)
  projectId  String?
  project    Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([createdById])
  @@index([projectId])
  @@index([organizationId])
  @@index([isEnabled])
}

// ============================================
// KNOWLEDGE BASE / WIKI
// ============================================

model KnowledgeDocument {
  id          String           @id @default(cuid())
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  title       String
  content     String           @db.Text
  type        DocumentType     @default(document)
  category    DocumentCategory @default(other)
  
  // File info (for non-document types)
  fileUrl     String?
  fileSize    Int?
  mimeType    String?
  
  // Metadata
  tags        Json             @default("[]")
  
  // Creator
  createdById String
  createdBy   User             @relation("DocumentCreator", fields: [createdById], references: [id])
  
  // Last modifier
  lastModifiedById String?
  lastModifiedBy   User?       @relation("DocumentModifier", fields: [lastModifiedById], references: [id])
  
  // Project (optional - docs can be org-wide or project-specific)
  projectId   String?
  project     Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Stars/favorites
  stars       DocumentStar[]
  
  // Linked nodes
  linkedNodes DocumentNodeLink[]
  
  @@index([createdById])
  @@index([projectId])
  @@index([organizationId])
  @@index([category])
  @@index([type])
  @@index([title])
}

model DocumentStar {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  
  documentId  String
  document    KnowledgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([documentId, userId])
  @@index([documentId])
  @@index([userId])
}

model DocumentNodeLink {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  
  documentId  String
  document    KnowledgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  nodeId      String
  
  @@unique([documentId, nodeId])
  @@index([documentId])
  @@index([nodeId])
}

// ============================================
// TIME TRACKING & WORKLOAD
// ============================================

model TimeEntry {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  date        DateTime
  hours       Float
  description String?
  billable    Boolean  @default(true)
  
  // User who logged the time
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Node (required - time is always logged against a node)
  nodeId      String
  node        Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  
  // Project (denormalized for easier queries)
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([nodeId])
  @@index([projectId])
  @@index([date])
}

model WorkloadEntry {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Week start date (normalized to Monday)
  weekStart   DateTime
  
  // User
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Capacity and allocation
  capacityHours    Float    @default(40)
  allocatedHours   Float    @default(0)
  actualHours      Float    @default(0)
  
  // Computed score (0-100)
  workloadScore    Int      @default(0)
  
  // Status
  status      String   @default("balanced") // overloaded, busy, balanced, available
  
  // Stats
  nodesCount       Int      @default(0)
  overdueCount     Int      @default(0)
  completedCount   Int      @default(0)
  
  @@unique([userId, weekStart])
  @@index([userId])
  @@index([weekStart])
  @@index([status])
}

// ============================================
// NODE HANDOFFS
// ============================================

model NodeHandoff {
  id          String        @id @default(cuid())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  status      HandoffStatus @default(pending)
  notes       String?       @db.Text
  
  // Checklist items completed (stored as JSON)
  checklistCompleted Json   @default("[]")
  
  // Node being handed off
  nodeId      String
  node        Node          @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  
  // From user
  fromUserId  String
  fromUser    User          @relation("HandoffFrom", fields: [fromUserId], references: [id])
  
  // To user
  toUserId    String
  toUser      User          @relation("HandoffTo", fields: [toUserId], references: [id])
  
  // Completion
  completedAt DateTime?
  
  @@index([nodeId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([status])
}

// ============================================
// RESOURCES & ALLOCATION
// ============================================

model Resource {
  id          String       @id @default(cuid())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  name        String
  description String?
  type        ResourceType @default(other)
  
  // Capacity (e.g., hours per day for person, quantity for equipment)
  capacity    Float        @default(8)
  unit        String       @default("hours")
  
  // Cost
  hourlyRate  Float?
  currency    String       @default("USD")
  
  // Availability
  isAvailable Boolean      @default(true)
  
  // Creator
  createdById String
  createdBy   User         @relation("ResourceCreator", fields: [createdById], references: [id])
  
  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Allocations
  allocations ResourceAllocation[]
  
  @@index([createdById])
  @@index([organizationId])
  @@index([type])
  @@index([isAvailable])
}

model ResourceAllocation {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Dates
  startDate   DateTime
  endDate     DateTime
  
  // Hours per day/period
  hoursPerDay Float    @default(8)
  
  // Resource
  resourceId  String
  resource    Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  
  // Allocated to user (if resource type is person, this links to the user)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  
  // For project
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Node (optional - can be allocated to project or specific node)
  nodeId      String?
  
  // Notes
  notes       String?
  
  @@index([resourceId])
  @@index([userId])
  @@index([projectId])
  @@index([startDate])
  @@index([endDate])
}

// ============================================
// BUDGETS
// ============================================

model Budget {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  name        String
  description String?
  
  // Amount
  totalAmount Float
  currency    String   @default("USD")
  
  // Period
  startDate   DateTime?
  endDate     DateTime?
  
  // Type
  type        String   @default("project") // project, team, department
  
  // Creator
  createdById String
  createdBy   User     @relation("BudgetCreator", fields: [createdById], references: [id])
  
  // Project (optional)
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Line items
  lineItems   BudgetLineItem[]
  
  @@index([createdById])
  @@index([projectId])
  @@index([organizationId])
}

model BudgetLineItem {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  name        String
  description String?
  category    String   // Design, Development, Testing, Marketing, etc.
  
  // Amounts
  plannedAmount Float
  actualAmount  Float  @default(0)
  
  // Budget
  budgetId    String
  budget      Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  
  @@index([budgetId])
  @@index([category])
}

// ============================================
// COUNTRY HOLIDAYS (different from HolidayRequest)
// ============================================

model CountryHoliday {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  
  name        String
  date        DateTime
  country     String   // ISO country code (US, PT, ES, etc.)
  emoji       String?
  color       String?
  
  // Recurring yearly
  isRecurring Boolean  @default(true)
  
  // Organization (holidays can be org-specific)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([date])
  @@index([country])
  @@index([organizationId])
}

// ============================================
// PROJECT TIMELINE ITEMS (for Gantt-like views)
// ============================================

model TimelineItem {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  name        String
  description String?
  
  // Dates
  startDate   DateTime
  endDate     DateTime
  
  // Progress (0-100)
  progress    Int      @default(0)
  
  // Color
  color       String   @default("#6366f1")
  
  // Type
  type        String   @default("task") // task, milestone, phase
  
  // Priority
  priority    TaskPriority @default(medium)
  
  // Project
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Assignee
  assigneeId  String?
  
  // Parent (for nested items)
  parentId    String?
  parent      TimelineItem?  @relation("TimelineHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    TimelineItem[] @relation("TimelineHierarchy")
  
  // Dependencies
  dependencies TimelineDependency[] @relation("DependentItem")
  dependents   TimelineDependency[] @relation("DependencyItem")
  
  @@index([projectId])
  @@index([assigneeId])
  @@index([parentId])
  @@index([startDate])
  @@index([endDate])
}

model TimelineDependency {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  
  // Dependency type
  type        String   @default("finish_to_start") // finish_to_start, start_to_start, finish_to_finish, start_to_finish
  
  // The item that depends on another
  dependentItemId String
  dependentItem   TimelineItem @relation("DependentItem", fields: [dependentItemId], references: [id], onDelete: Cascade)
  
  // The item being depended upon
  dependencyItemId String
  dependencyItem   TimelineItem @relation("DependencyItem", fields: [dependencyItemId], references: [id], onDelete: Cascade)
  
  // Lag (days offset)
  lagDays     Int      @default(0)
  
  @@unique([dependentItemId, dependencyItemId])
  @@index([dependentItemId])
  @@index([dependencyItemId])
}
