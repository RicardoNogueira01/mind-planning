import React, { useState } from 'react';
import { createPortal } from 'react-dom';
import PropTypes from 'prop-types';
import NodePopup from '../mindmap/NodePopup';

const EMOJI_CATEGORIES = {
  'Smileys': [
    'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Š',
    'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™', 'ğŸ¥²', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ',
    'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶',
    'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ˜®â€ğŸ’¨', 'ğŸ¤¥', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·',
    'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³',
    'ğŸ¥¸', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ˜•', 'ğŸ˜Ÿ', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³',
    'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£', 'ğŸ˜',
    'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ’€', 'â˜ ï¸'
  ],
  'Gestures': [
    'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜',
    'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘', 'âœŠ', 'ğŸ‘Š', 'ğŸ¤›',
    'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'âœï¸', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦¿', 'ğŸ¦µ'
  ],
  'People': [
    'ğŸ‘¶', 'ğŸ§’', 'ğŸ‘¦', 'ğŸ‘§', 'ğŸ§‘', 'ğŸ‘±', 'ğŸ‘¨', 'ğŸ§”', 'ğŸ‘©', 'ğŸ§“', 'ğŸ‘´', 'ğŸ‘µ',
    'ğŸ™', 'ğŸ™', 'ğŸ™…', 'ğŸ™†', 'ğŸ’', 'ğŸ™‹', 'ğŸ§', 'ğŸ™‡', 'ğŸ¤¦', 'ğŸ¤·', 'ğŸ‘®', 'ğŸ•µï¸',
    'ğŸ’‚', 'ğŸ¥·', 'ğŸ‘·', 'ğŸ¤´', 'ğŸ‘¸', 'ğŸ‘³', 'ğŸ‘²', 'ğŸ§•', 'ğŸ¤µ', 'ğŸ‘°', 'ğŸ¤°', 'ğŸ«ƒ',
    'ğŸ‘¼', 'ğŸ…', 'ğŸ¤¶', 'ğŸ¦¸', 'ğŸ¦¹', 'ğŸ§™', 'ğŸ§š', 'ğŸ§›', 'ğŸ§œ', 'ğŸ§', 'ğŸ§', 'ğŸ§Ÿ'
  ],
  'Animals': [
    'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ»â€â„ï¸', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦',
    'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ’', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤',
    'ğŸ¦†', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦‡', 'ğŸº', 'ğŸ—', 'ğŸ´', 'ğŸ¦„', 'ğŸ', 'ğŸª±', 'ğŸ›', 'ğŸ¦‹',
    'ğŸŒ', 'ğŸ', 'ğŸœ', 'ğŸª°', 'ğŸª²', 'ğŸª³', 'ğŸ¦Ÿ', 'ğŸ¦—', 'ğŸ•·ï¸', 'ğŸ¦‚', 'ğŸ¢', 'ğŸ',
    'ğŸ¦', 'ğŸ¦–', 'ğŸ¦•', 'ğŸ™', 'ğŸ¦‘', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦€', 'ğŸ¡', 'ğŸ ', 'ğŸŸ', 'ğŸ¬',
    'ğŸ³', 'ğŸ‹', 'ğŸ¦ˆ', 'ğŸŠ', 'ğŸ…', 'ğŸ†', 'ğŸ¦“', 'ğŸ¦', 'ğŸ¦§', 'ğŸ˜', 'ğŸ¦›', 'ğŸ¦'
  ],
  'Food': [
    'ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸ«', 'ğŸˆ', 'ğŸ’', 'ğŸ‘',
    'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ¥', 'ğŸ…', 'ğŸ†', 'ğŸ¥‘', 'ğŸ¥¦', 'ğŸ¥¬', 'ğŸ¥’', 'ğŸŒ¶ï¸', 'ğŸ«‘',
    'ğŸŒ½', 'ğŸ¥•', 'ğŸ«’', 'ğŸ§„', 'ğŸ§…', 'ğŸ¥”', 'ğŸ ', 'ğŸ¥', 'ğŸ¥¯', 'ğŸ', 'ğŸ¥–', 'ğŸ¥¨',
    'ğŸ§€', 'ğŸ¥š', 'ğŸ³', 'ğŸ§ˆ', 'ğŸ¥', 'ğŸ§‡', 'ğŸ¥“', 'ğŸ¥©', 'ğŸ—', 'ğŸ–', 'ğŸ¦´', 'ğŸŒ­',
    'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸ«“', 'ğŸ¥ª', 'ğŸ¥™', 'ğŸ§†', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ«”', 'ğŸ¥—', 'ğŸ¥˜',
    'ğŸ«•', 'ğŸ', 'ğŸœ', 'ğŸ²', 'ğŸ›', 'ğŸ£', 'ğŸ±', 'ğŸ¥Ÿ', 'ğŸ¦ª', 'ğŸ¤', 'ğŸ™', 'ğŸš'
  ],
  'Activities': [
    'âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±', 'ğŸª€', 'ğŸ“',
    'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸªƒ', 'ğŸ¥…', 'â›³', 'ğŸª', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿',
    'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ½', 'ğŸ›¹', 'ğŸ›¼', 'ğŸ›·', 'â›¸ï¸', 'ğŸ¥Œ', 'ğŸ¿', 'â›·ï¸', 'ğŸ‚', 'ğŸª‚',
    'ğŸ‹ï¸', 'ğŸ¤¼', 'ğŸ¤¸', 'â›¹ï¸', 'ğŸ¤º', 'ğŸ¤¾', 'ğŸŒï¸', 'ğŸ‡', 'ğŸ§˜', 'ğŸ„', 'ğŸŠ', 'ğŸ¤½',
    'ğŸš£', 'ğŸ§—', 'ğŸšµ', 'ğŸš´', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ…', 'ğŸ–ï¸', 'ğŸµï¸', 'ğŸ—ï¸'
  ],
  'Travel': [
    'ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸ›»', 'ğŸšš',
    'ğŸš›', 'ğŸšœ', 'ğŸï¸', 'ğŸ›µ', 'ğŸš²', 'ğŸ›´', 'ğŸ›¹', 'ğŸš¨', 'ğŸš”', 'ğŸš', 'ğŸš˜', 'ğŸš–',
    'ğŸš¡', 'ğŸš ', 'ğŸšŸ', 'ğŸšƒ', 'ğŸš‹', 'ğŸš', 'ğŸš', 'ğŸš„', 'ğŸš…', 'ğŸšˆ', 'ğŸš‚', 'ğŸš†',
    'ğŸš‡', 'ğŸšŠ', 'ğŸš‰', 'âœˆï¸', 'ğŸ›«', 'ğŸ›¬', 'ğŸ›©ï¸', 'ğŸ’º', 'ğŸ›°ï¸', 'ğŸš€', 'ğŸ›¸', 'ğŸš',
    'ğŸ›¶', 'â›µ', 'ğŸš¤', 'ğŸ›¥ï¸', 'ğŸ›³ï¸', 'â›´ï¸', 'ğŸš¢', 'âš“', 'ğŸª', 'â›½', 'ğŸš§', 'ğŸš¦'
  ],
  'Objects': [
    'âŒš', 'ğŸ“±', 'ğŸ“²', 'ğŸ’»', 'âŒ¨ï¸', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'ğŸ–±ï¸', 'ğŸ–²ï¸', 'ğŸ’½', 'ğŸ’¾', 'ğŸ’¿',
    'ğŸ“€', 'ğŸ§®', 'ğŸ¥', 'ğŸï¸', 'ğŸ“½ï¸', 'ğŸ¬', 'ğŸ“º', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ“¼', 'ğŸ”',
    'ğŸ”', 'ğŸ•¯ï¸', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ®', 'ğŸª”', 'ğŸ“”', 'ğŸ“•', 'ğŸ“–', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™',
    'ğŸ“š', 'ğŸ““', 'ğŸ“’', 'ğŸ“ƒ', 'ğŸ“œ', 'ğŸ“„', 'ğŸ“°', 'ğŸ—ï¸', 'ğŸ“‘', 'ğŸ”–', 'ğŸ·ï¸', 'ğŸ’°',
    'ğŸª™', 'ğŸ’´', 'ğŸ’µ', 'ğŸ’¶', 'ğŸ’·', 'ğŸ’¸', 'ğŸ’³', 'ğŸ§¾', 'âœ‰ï¸', 'ğŸ“§', 'ğŸ“¨', 'ğŸ“©',
    'ğŸ“¦', 'ğŸ“«', 'ğŸ“ª', 'ğŸ“¬', 'ğŸ“­', 'ğŸ“®', 'ğŸ—³ï¸', 'âœï¸', 'âœ’ï¸', 'ğŸ–‹ï¸', 'ğŸ–Šï¸', 'ğŸ–Œï¸'
  ],
  'Symbols': [
    'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•',
    'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'â˜®ï¸', 'âœï¸', 'â˜ªï¸', 'ğŸ•‰ï¸', 'â˜¸ï¸',
    'âœ¡ï¸', 'ğŸ”¯', 'ğŸ•', 'â˜¯ï¸', 'â˜¦ï¸', 'ğŸ›', 'â›', 'â™ˆ', 'â™‰', 'â™Š', 'â™‹', 'â™Œ',
    'â™', 'â™', 'â™', 'â™', 'â™‘', 'â™’', 'â™“', 'ğŸ†”', 'âš›ï¸', 'ğŸ‰‘', 'â˜¢ï¸', 'â˜£ï¸',
    'ğŸ“´', 'ğŸ“³', 'ğŸˆ¶', 'ğŸˆš', 'ğŸˆ¸', 'ğŸˆº', 'ğŸˆ·ï¸', 'âœ´ï¸', 'ğŸ†š', 'ğŸ’®', 'ğŸ‰', 'ãŠ™ï¸',
    'ãŠ—ï¸', 'ğŸˆ´', 'ğŸˆµ', 'ğŸˆ¹', 'ğŸˆ²', 'ğŸ…°ï¸', 'ğŸ…±ï¸', 'ğŸ†', 'ğŸ†‘', 'ğŸ…¾ï¸', 'ğŸ†˜', 'â­•',
    'âœ…', 'â˜‘ï¸', 'âœ”ï¸', 'âŒ', 'â', 'â•', 'â–', 'â—', 'â°', 'â¿', 'ã€½ï¸', 'âœ³ï¸',
    'âœ´ï¸', 'â‡ï¸', 'â€¼ï¸', 'â‰ï¸', 'â“', 'â”', 'â•', 'â—', 'ã€°ï¸', 'Â©ï¸', 'Â®ï¸', 'â„¢ï¸'
  ]
};

export default function EmojiPicker({ show, anchorRef, onSelect, onClose }) {
  const [activeCategory, setActiveCategory] = useState('Smileys');

  if (!show) return null;

  const rect = anchorRef?.current?.getBoundingClientRect() ||
    { left: window.innerWidth / 2, top: 80, width: 0, height: 0, bottom: 100 };

  // Use 580px for positioning (matches CSS min-width), actual width handled by CSS
  const popupWidth = 580;
  const left = Math.max(8, Math.min(rect.left + (rect.width / 2) - (popupWidth / 2), window.innerWidth - popupWidth - 8));
  const top = Math.max(8, rect.bottom + 20);

  const categoryNames = Object.keys(EMOJI_CATEGORIES);

  const CATEGORY_ICONS = {
    'Smileys': 'ğŸ˜€',
    'Gestures': 'ğŸ‘Œ',
    'People': 'ğŸ§‘',
    'Animals': 'ğŸ¶',
    'Food': 'ğŸ',
    'Activities': 'âš½',
    'Travel': 'ğŸš—',
    'Objects': 'ğŸ’¡',
    'Symbols': 'â¤ï¸'
  };

  return createPortal(
    <NodePopup
      position={{ left, top }}
      width={popupWidth}
      maxHeight="450px"
      onClose={onClose}
      title="Select Emoji"
    >
      {/* Category Tabs */}
      <div className="flex gap-2 mb-3 overflow-x-auto pb-2 border-b border-gray-100 justify-between px-2">
        {categoryNames.map(category => (
          <button
            key={category}
            className={`p-2 text-xl rounded-lg whitespace-nowrap transition-all ${activeCategory === category
              ? 'bg-blue-100 scale-110'
              : 'hover:bg-gray-100 hover:scale-110 opacity-70 hover:opacity-100'
              }`}
            onClick={() => setActiveCategory(category)}
            title={category}
          >
            {CATEGORY_ICONS[category] || category}
          </button>
        ))}
      </div>

      {/* Emoji Grid */}
      <div className="grid grid-cols-12 gap-0.5 max-h-72 overflow-y-auto">
        {EMOJI_CATEGORIES[activeCategory].map(emoji => (
          <button
            key={emoji}
            className="p-1.5 text-base hover:bg-gray-100 rounded cursor-pointer transition-colors flex items-center justify-center"
            onClick={(e) => {
              e.stopPropagation();
              onSelect(emoji);
            }}
          >
            {emoji}
          </button>
        ))}
      </div>
    </NodePopup>,
    document.body
  );
}

EmojiPicker.propTypes = {
  show: PropTypes.bool.isRequired,
  anchorRef: PropTypes.object,
  onSelect: PropTypes.func.isRequired,
  onClose: PropTypes.func.isRequired
};
